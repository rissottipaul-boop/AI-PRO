# Copilot Coding Agent Instructions

## Mission
Автоматизировать развитие проекта (качество, безопасность, функциональность) без снижения строгих стандартов.

## Core Principles
- **Predictability**: Код должен быть предсказуемым и поддерживаемым
- **Test-first**: Тесты создаются или обновляются при любом изменении логики
- **Minimal surface change per PR**: Один логический блок работы — один PR
- **Reproducibility**: Не ломать локальные dev-потоки

## Tooling Contract

### Обязательные проверки перед коммитом:
```bash
# 1. Pre-commit hooks
pre-commit run --all-files

# 2. Tests with coverage
pytest --cov=src/autonomous_dev --cov-fail-under=85
```

### Правила:
- Не ослабляйте строгость mypy без явного обоснования
- Не удаляйте тесты без причины
- Покрытие должно оставаться >= 85%

## Allowed Changes

### ✅ Разрешено:
- Добавление новой функциональности с тестами
- Рефакторинг с сохранением поведения (описать инварианты)
- Обновление зависимостей (со ссылкой на changelog)
- Исправления безопасности (ссылка на CVE или advisory)
- Мелкий рефакторинг вместе с разработкой фичи (изолированно)

### ❌ Запрещено без явного одобрения:
- Удаление или ослабление инструментов безопасности
- Массовые переименования, затрагивающие >100 файлов
- Внедрение внешнего кода без проверки
- Снижение уровня строгости mypy
- Массовое обновление десятков пакетов без анализа
- Сочетание глобального рефакторинга с новой функцией

## Commit Conventions (Conventional Commits)

Используйте стандарт Conventional Commits для всех коммитов:

- `feat: ...` — новая функциональность
- `fix: ...` — исправление ошибки
- `refactor: ...` — изменение без изменения поведения
- `test: ...` — только тесты
- `chore: ...` — инфраструктура / мета
- `docs: ...` — документация
- `perf: ...` — производительность
- `build|ci: ...` — сборка / пайплайн

### Примеры:
```
feat: add multiply function to example module
fix: handle edge case in sum_all for empty lists
docs: update README with new installation instructions
test: add tests for error handling in sum_all
```

## Branching Strategy

Используйте префиксы для веток:
- `feat/<кратко>` — новая функциональность
- `fix/<кратко>` — исправление
- `chore/<кратко>` — инфраструктура
- `auto/dep-update-<date>` — автоматические обновления зависимостей

## Development Flow

### Порядок действий:
1. Прочитать `.github/COPILOT_INSTRUCTIONS.md` и roadmap/policy
2. Сформировать список задач (todo list)
3. Создать ветку с правильным префиксом
4. Внести изменения → прогнать локальные проверки (lint/type/test)
5. Обновить/создать тесты при любом изменении логики
6. Открыть PR с чек-листом (см. ниже)
7. Обработать feedback / дождаться зелёного CI → готово

## PR Checklist

Каждый PR должен включать этот чек-лист:

```markdown
- [ ] Изменения логически атомарны
- [ ] Обновлены/добавлены тесты
- [ ] Локально: pre-commit прошёл
- [ ] Локально: pytest в порядке
- [ ] Нет снижения покрытия
- [ ] Статический анализ не ослабевает
- [ ] Документация обновлена (при необходимости)
- [ ] Отсутствуют «лишние» файлы (мусорные / временные)
```

## Quality Standards

### Текущие стандарты:
- **Язык**: Python 3.11–3.13
- **Качество**: pre-commit (ruff, format, mypy), тесты + покрытие (>=85%)
- **Безопасность**: bandit, pip-audit, deptry в CI
- **Релизы**: GitHub Actions + OIDC → PyPI
- **Стиль**: Ruff + Black, длина строки 100 символов

### Инструменты:
- **Линтер**: Ruff (0 ошибок требуется)
- **Форматтер**: Black + Ruff format
- **Типы**: mypy в strict режиме
- **Тесты**: pytest + pytest-cov
- **Безопасность**: bandit, pip-audit (fail on HIGH), deptry

## Edge Cases

### Если нужно ослабить правило:
1. Создайте отдельный PR с пояснениями
2. Используйте узкие ignore (per line), а не глобальные изменения конфигурации
3. Документируйте причину в PR описании

### Если инструмент в CI нестабилен:
1. Зафиксируйте версию инструмента
2. Опишите проблему в PR
3. Предложите решение

### Если нужен новый пакет:
1. Обоснуйте необходимость
2. Рассмотрите альтернативы
3. Проверьте поддержку и безопасность
4. Добавьте в pyproject.toml с указанием минимальной версии

## Current Context

### Структура проекта:
```
src/autonomous_dev/        # исходный код
tests/                     # тесты
.github/workflows/ci.yml   # CI pipeline
.github/workflows/release.yml # Release pipeline
automation_policy.yaml     # Политика автономии
ARCHITECTURE.md            # Архитектура
DECISIONS/                 # ADR решения
roadmap.yaml               # Дорожная карта
```

### Автономный рабочий цикл:
1. Анализ задач (todo) — явная фиксация шагов
2. Мелкие атомарные изменения
3. Немедленная валидация (линт/типы/тесты)
4. CI (matrix + security) подтверждает корректность
5. Метрики (coverage + security) → артефакты
6. Автовыпуск при изменении версии

## Success Criteria

PR считается готовым к merge, когда:
- ✅ Все проверки CI зелёные
- ✅ Покрытие >= 85%
- ✅ Код соответствует стандартам (ruff + black + mypy)
- ✅ Тесты проходят на всех версиях Python (3.11, 3.12, 3.13)
- ✅ Безопасность: нет HIGH уязвимостей
- ✅ PR описание понятно и включает чек-лист

## General Rules

### Всегда:
- Никогда не добавляйте зависимости без явной причины
- Любой публичный API должен быть задокументирован (docstring + README/CHANGELOG)
- Сохраняйте существующие лимиты: покрытие, строгость mypy
- Один логический блок работы — один PR

### Перед коммитом:
- Запустите `pre-commit run --all-files`
- Запустите `pytest`
- Проверьте, что не добавились временные файлы

### В PR описании:
- Краткое описание мотивации
- Список изменений (по пунктам)
- Потенциальные риски и откаты

## References

- [Ruff Documentation](https://docs.astral.sh/ruff/)
- [pytest Documentation](https://docs.pytest.org/)
- [mypy Documentation](https://mypy.readthedocs.io/)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [GitHub Actions](https://docs.github.com/en/actions)

---

**Status**: ✅ Instructions active
**Last Updated**: 2025-01-04
